<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 關鍵：禁止縮放，確保 APP 質感 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>明基材料工安防護具挑戰</title>
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f1f5f9;
            /* 關鍵：防止手機下拉刷新導致頁面跳動 */
            overscroll-behavior: none;
        }
        .loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #ffffff; z-index: 9999; text-align: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #652d90; border-radius: 50%; /* BenQ Purple */
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(101, 45, 144, 0.3); border-radius: 4px; }
    </style>

    <script>
        function handleScriptError(e) {
            alert("⚠️ 網路資源載入失敗！請檢查網路連線。");
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com" onerror="handleScriptError(this)"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js" onerror="handleScriptError(this)"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onerror="handleScriptError(this)"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" onerror="handleScriptError(this)"></script>

    <script>
        window.onload = function() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                benq: {
                                    DEFAULT: '#652d90', // BenQ Purple
                                    hover: '#502379',
                                    light: '#8e56b8',
                                    dark: '#4a1d6e',
                                }
                            },
                            animation: {
                                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                                'shake': 'shake 0.5s ease-in-out',
                                'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                            },
                            keyframes: {
                                shake: {
                                    '0%, 100%': { transform: 'translateX(0)' },
                                    '25%': { transform: 'translateX(-5px)' },
                                    '75%': { transform: 'translateX(5px)' },
                                },
                                fadeIn: {
                                    'from': { opacity: '0', transform: 'translateY(10px)' },
                                    'to': { opacity: '1', transform: 'translateY(0)' },
                                }
                            }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 h-[100dvh] overflow-hidden flex flex-col">
    
    <div id="root" class="h-full flex flex-col">
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <h2 class="text-gray-600 text-xl font-bold">載入中...</h2>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icon Components ---
        const IconBase = ({ size = 24, className = "", children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const XCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>;
        const Construction = (p) => <IconBase {...p}><rect x="2" y="6" width="20" height="8" rx="1"></rect><path d="M17 14v7"></path><path d="M7 14v7"></path><path d="M17 3v3"></path><path d="M7 3v3"></path><path d="M10 14 2.3 6.3"></path><path d="m14 6 7.7 7.7"></path><path d="m8 6 8 8"></path></IconBase>;
        const Timer = (p) => <IconBase {...p}><line x1="10" y1="2" x2="14" y2="2"></line><line x1="12" y1="14" x2="15.51" y2="11.51"></line><circle cx="12" cy="14" r="8"></circle></IconBase>;
        const Lightbulb = (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2 1.5-3.5A6 6 0 0 0 6 8c0 1 .5 2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"></path><path d="M9 18h6"></path><path d="M10 22h4"></path></IconBase>;
        const ShieldAlert = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const Hammer = (p) => <IconBase {...p}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"></path><path d="M17.64 15 22 10.64"></path><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H16.5c-.55 0-1 .45-1 1v.36c0 .84-.33 1.65-.93 2.25L13.36 11.7a2.5 2.5 0 0 0 0 3.54l1.25 1.25a2.5 2.5 0 0 0 3.54 0z"></path><path d="m3.5 3.5 6 6"></path><path d="m2 2 2 2"></path></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M9 14.66V17a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-2.34l-3.14-3.14a3 3 0 0 1-.72-1.54l-.52-2.28"></path><path d="M19.42 4.94A2 2 0 0 0 18 4H6a2 2 0 0 0-1.42.94L2 9.07a2.12 2.12 0 0 0 .59 2.14l8.28 7.37a2 2 0 0 0 2.26 0l8.28-7.37a2.12 2.12 0 0 0 .59-2.14z"></path></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>;
        const ListOrdered = (p) => <IconBase {...p}><line x1="10" y1="6" x2="21" y2="6"></line><line x1="10" y1="12" x2="21" y2="12"></line><line x1="10" y1="18" x2="21" y2="18"></line><path d="M4 6h1v4"></path><path d="M4 10h2"></path><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path></IconBase>;
        const Play = (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></IconBase>;
        const Building2 = (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path></IconBase>;
        const UserCheck = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><polyline points="16 11 18 13 22 9"></polyline></IconBase>;

        // --- Custom PPE Icons (SVG) ---
        const IconHelmet = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 36c0-14 10-26 28-26s28 12 28 26v4H4v-4z" fill="#FBBF24" stroke="#D97706" /><path d="M32 10v4M4 36h56M12 36c0-4 2-8 6-8h28c4 0 6 4 6 8" stroke="#D97706" strokeLinecap="round"/><path d="M28 14h8" stroke="#D97706" strokeWidth="3"/></svg>;
        const IconGoggles = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M12 28c0-6 4-10 10-10h6c2 0 4 2 4 4s2 4 4 4 4-2 4-4 2-4 4-4h6c6 0 10 4 10 10v6c0 6-4 10-10 10h-6c-2 0-4-2-4-4s-2-4-4-4-4 2-4 4-2 4-4 4h-6c-6 0-10-4-10-10v-6z" fill="#BFDBFE" stroke="#2563EB" strokeWidth="3"/><path d="M4 30h8M52 30h8" stroke="#1F2937" strokeWidth="3" strokeLinecap="round"/></svg>;
        const IconWeldingMask = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><rect x="14" y="8" width="36" height="48" rx="8" fill="#1F2937" stroke="#000" strokeWidth="2"/><rect x="20" y="20" width="24" height="12" rx="2" fill="#111827" stroke="#F59E0B" strokeWidth="2"/><path d="M22 26h20" stroke="#F59E0B" strokeWidth="1" opacity="0.5"/></svg>;
        const IconFaceShield = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M16 12h32v4H16z" fill="#374151" stroke="#000" strokeWidth="2"/><path d="M16 16v32c0 8 8 12 16 12s16-4 16-12V16H16z" fill="#A7F3D0" stroke="#059669" strokeWidth="2" fillOpacity="0.6"/><path d="M24 24l16 16" stroke="#059669" strokeWidth="1" opacity="0.5"/></svg>;
        const IconEarmuffs = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M12 18a4 4 0 0 1 4-4h32a4 4 0 0 1 4 4v20" stroke="#374151" strokeWidth="3" strokeLinecap="round"/><rect x="6" y="24" width="12" height="24" rx="6" fill="#F97316" stroke="#C2410C" strokeWidth="2"/><rect x="46" y="24" width="12" height="24" rx="6" fill="#F97316" stroke="#C2410C" strokeWidth="2"/><path d="M10 30h4M50 30h4" stroke="#FFF" strokeOpacity="0.5"/></svg>;
        const IconGasMask = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M16 16h32v24c0 10-8 16-16 16s-16-6-16-16V16z" fill="#374151" stroke="#111827" strokeWidth="2"/><circle cx="22" cy="28" r="6" fill="#111827" stroke="#6B7280" strokeWidth="2"/><circle cx="42" cy="28" r="6" fill="#111827" stroke="#6B7280" strokeWidth="2"/><rect x="26" y="40" width="12" height="12" rx="2" fill="#4B5563" stroke="#9CA3AF" strokeWidth="2"/></svg>;
        const IconN95 = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M14 20c0-2 18-6 18-6s18 4 18 6c0 10-4 26-18 26s-18-16-18-26z" fill="#F9FAFB" stroke="#9CA3AF" strokeWidth="2"/><path d="M8 24h6M50 24h6" stroke="#FCA5A5" strokeWidth="2"/><circle cx="24" cy="28" r="2" fill="#D1D5DB"/></svg>;
        const IconHarness = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M16 8v48M48 8v48" stroke="#EF4444" strokeWidth="4"/><path d="M16 20h32M16 40h32" stroke="#EF4444" strokeWidth="4"/><path d="M16 12l32 40M48 12L16 52" stroke="#B91C1C" strokeWidth="3"/></svg>;
        const IconVest = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M12 12h12l8 16 8-16h12v40H12V12z" fill="#A3E635" stroke="#4D7C0F" strokeWidth="2"/><path d="M12 36h40M12 44h40" stroke="#E5E7EB" strokeWidth="4"/><path d="M22 12v40M42 12v40" stroke="#E5E7EB" strokeWidth="4"/></svg>;
        const IconApron = () => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M22 8h20v8H22z" stroke="#1D4ED8" strokeWidth="2"/><path d="M18 16h28l4 8v32H14V24l4-8z" fill="#2563EB" stroke="#1E40AF" strokeWidth="2"/><path d="M24 30h16" stroke="#60A5FA" strokeWidth="2" opacity="0.5"/></svg>;
        const IconGlove = ({ color, type }) => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M20 54V30a4 4 0 0 1 8 0v-4a4 4 0 0 1 8 0v-2a4 4 0 0 1 8 0v4a4 4 0 0 1 8 0v26H20z" fill={color} stroke="#4B5563" strokeWidth="2"/><path d="M20 50h32" stroke="#000" strokeOpacity="0.1"/>{type === 'dot' && <circle cx="32" cy="40" r="1" fill="#000" opacity="0.2"/>}{type === 'line' && <path d="M28 36v10" stroke="#000" opacity="0.1"/>}</svg>;
        const IconBoot = ({ color, sole }) => <svg viewBox="0 0 64 64" className="w-full h-full" fill="none"><path d="M18 12h16v24h14c4 0 6 4 6 8v8H14V16c0-2 2-4 4-4z" fill={color} stroke="#1F2937" strokeWidth="2"/><path d="M14 52h40v4H14z" fill={sole} stroke="#000" strokeWidth="1"/><path d="M18 16h16" stroke="#FFF" strokeOpacity="0.2"/></svg>;

        const EQUIPMENT_LIST = [
          { id: 'helmet', name: '工業安全帽', Component: IconHelmet, category: 'head', color: 'bg-yellow-400' },
          { id: 'goggles', name: '安全護目鏡', Component: IconGoggles, category: 'eyes', color: 'bg-blue-200' },
          { id: 'mask_welding', name: '焊接面罩', Component: IconWeldingMask, category: 'eyes', color: 'bg-gray-800' },
          { id: 'shield_face', name: '防護面罩', Component: IconFaceShield, category: 'eyes', color: 'bg-emerald-200' },
          { id: 'earmuffs', name: '防音耳罩', Component: IconEarmuffs, category: 'ears', color: 'bg-orange-400' },
          { id: 'mask_gas', name: '防毒面具', Component: IconGasMask, category: 'face', color: 'bg-gray-700' },
          { id: 'mask_dust', name: 'N95口罩', Component: IconN95, category: 'face', color: 'bg-white' },
          { id: 'harness', name: '高空安全帶', Component: IconHarness, category: 'body_acc', color: 'bg-red-500' },
          { id: 'vest', name: '反光背心', Component: IconVest, category: 'body', color: 'bg-lime-400' },
          { id: 'apron', name: '防護圍裙', Component: IconApron, category: 'body_outer', color: 'bg-blue-700' },
          { id: 'gloves_cotton', name: '棉紗手套', Component: () => <IconGlove color="#E5E7EB" type="dot"/>, category: 'hands', color: 'bg-gray-200' },
          { id: 'gloves_rubber', name: '耐化學手套', Component: () => <IconGlove color="#A855F7" type="line"/>, category: 'hands', color: 'bg-purple-500' },
          { id: 'gloves_insulation', name: '絕緣手套', Component: () => <IconGlove color="#EA580C" />, category: 'hands', color: 'bg-orange-600' },
          { id: 'gloves_cut', name: '防切割手套', Component: () => <IconGlove color="#94A3B8" type="line"/>, category: 'hands', color: 'bg-slate-400' },
          { id: 'gloves_leather', name: '皮革手套', Component: () => <IconGlove color="#B45309" />, category: 'hands', color: 'bg-amber-700' },
          { id: 'safety_shoes', name: '鋼頭安全鞋', Component: () => <IconBoot color="#1F2937" sole="#000"/>, category: 'feet', color: 'bg-slate-800' },
          { id: 'boots_rubber', name: '防護雨鞋', Component: () => <IconBoot color="#CA8A04" sole="#854D0E"/>, category: 'feet', color: 'bg-yellow-600' },
        ];

        const SCENARIOS = [
          { id: 1, title: '高空鷹架作業', description: '在 5 公尺高的鷹架上維護外牆，上方偶爾有落石。', required: ['helmet', 'harness', 'safety_shoes'], hint: '【墜落危害】高處作業須配戴安全帶，並保護頭部與腳部。' },
          { id: 2, title: '調膠室溶劑調配', description: '室內充滿有機溶劑氣味，液體具腐蝕性且容易噴濺。', required: ['mask_gas', 'goggles', 'gloves_rubber', 'apron'], hint: '【化學危害】需防止吸入毒氣，並保護眼、身、手不被腐蝕。' },
          { id: 3, title: '發電機房巡檢', description: '機房內發電機運轉中，噪音高達 95 分貝。', required: ['earmuffs', 'safety_shoes', 'helmet'], hint: '【噪音危害】保護聽力是首要任務，同時注意頭部與腳部安全。' },
          { id: 4, title: '手持砂輪機研磨', description: '研磨金屬零件，有大量火花與金屬粉塵飛散。', required: ['goggles', 'mask_dust', 'gloves_cotton', 'earmuffs'], hint: '【粉塵/火花】防護眼、肺、手，且研磨噪音大需戴耳罩。' },
          { id: 5, title: '夜間道路搶修', description: '夜間在車流量大的馬路進行坑洞修補。', required: ['helmet', 'vest', 'safety_shoes'], hint: '【被撞危害】最重要的是高可視度反光背心。' },
          { id: 6, title: '配電盤活線作業', description: '檢修 220V 未斷電的配電盤設備。', required: ['helmet', 'gloves_insulation', 'safety_shoes', 'shield_face'], hint: '【感電危害】絕緣手套與面罩防止電弧灼傷是關鍵。' },
          { id: 7, title: '鋼構電銲作業', description: '焊接鋼材，產生強烈紫外線強光、高溫與金屬噴濺。', required: ['mask_welding', 'gloves_leather', 'apron', 'safety_shoes'], hint: '【光害/高溫】需焊接面罩擋強光，皮革手套與圍裙防高溫噴濺。' },
          { id: 8, title: '割草機除草', description: '使用背負式割草機，地面碎石容易飛濺。', required: ['shield_face', 'boots_rubber', 'apron', 'gloves_cotton'], hint: '【飛落物危害】碎石易傷臉與腿，需面罩與長筒雨鞋/圍裙。' },
          { id: 9, title: '廢棄玻璃清理', description: '清理含有大量碎玻璃與尖銳鐵片的廢棄物。', required: ['gloves_cut', 'safety_shoes', 'helmet'], hint: '【切割危害】首重手部防切割與足部防穿刺。' },
          { id: 10, title: '強酸地板清洗', description: '地面積水且使用強酸清潔劑，極度濕滑。', required: ['boots_rubber', 'gloves_rubber', 'goggles', 'mask_gas'], hint: '【化學/跌倒】需防滑防水雨鞋，與完整的抗酸防護。' },
          { id: 11, title: '鑽床/車床操作', description: '操作高速旋轉的機具進行金屬鑽孔與加工。', required: ['goggles', 'safety_shoes'], forbidden: ['hands'], hint: '【捲夾危害】旋轉機具「絕對禁止」戴手套，以免被捲入！' },
          { id: 12, title: '高溫熔煉爐作業', description: '在鑄造廠高溫熔爐旁作業，有熱輻射與金屬液噴濺風險。', required: ['helmet', 'shield_face', 'gloves_leather', 'apron', 'safety_shoes'], hint: '【高溫危害】全身需耐高溫防護：皮革手套、圍裙、面罩。' },
          { id: 13, title: '破碎機打石作業', description: '使用大型氣動破碎機拆除混泥土，噪音極大且粉塵多。', required: ['earmuffs', 'mask_dust', 'goggles', 'helmet', 'safety_shoes', 'gloves_cotton'], hint: '【噪音/粉塵】高分貝噪音需耳罩，並防護粉塵與飛石。' },
          { id: 14, title: '輸送帶維修 (運轉中)', description: '在運轉中的輸送帶旁進行目視檢查 (不可接觸)。', required: ['helmet', 'safety_shoes', 'goggles'], forbidden: ['hands'], hint: '【捲夾危害】靠近運轉中機械，嚴禁戴手套或寬鬆衣物以免捲入。' },
          { id: 15, title: '化學槽車卸料 (酸液)', description: '連接管線卸收高腐蝕性酸液，接口處可能噴濺。', required: ['shield_face', 'mask_gas', 'apron', 'gloves_rubber', 'boots_rubber'], hint: '【噴濺危害】最高規格化學防護：面罩+防毒+橡膠手套+圍裙+雨鞋。' },
          { id: 16, title: '堆高機駕駛', description: '駕駛堆高機在倉庫間搬運貨物，需注意頭頂貨物與周遭人員。', required: ['helmet', 'vest', 'safety_shoes'], hint: '【被撞/物體飛落】駕駛需戴安全帽防護落物，穿背心提升能見度。' },
          { id: 17, title: '金屬切割操作', description: '使用切割機進行金屬切斷，有鐵屑飛濺與極大噪音。', required: ['helmet', 'earmuffs', 'shield_face', 'gloves_cut', 'safety_shoes'], hint: '【切割/噪音】需防切割手套、面罩擋鐵屑，以及耳罩防噪音。' },
          { id: 18, title: '粉塵作業', description: '粒子添加作業，空氣中懸浮大量細微粉塵。', required: ['mask_dust', 'goggles', 'helmet', 'safety_shoes'], hint: '【粉塵危害】高濃度粉塵環境，N95等級以上口罩與護目鏡是必須的。' },
          { id: 19, title: '液態氮分裝操作', description: '分裝零下 196 度液態氮，極低溫液體可能噴濺。', required: ['shield_face', 'gloves_leather', 'apron', 'safety_shoes'], hint: '【低溫危害】防止凍傷與噴濺，需面罩與厚絕緣手套（如皮革）。' },
          { id: 20, title: '局限空間氣體偵測', description: '進入通風不良的地下道前，需先確認氣體狀況。', required: ['helmet', 'mask_gas', 'safety_shoes', 'harness'], hint: '【缺氧/中毒】雖是偵測，但需預設有危害：佩戴呼吸防護與救援用安全帶。' }
        ];

        const TOTAL_ROUNDS = 10;

        function SafetyGearGame() {
          const [currentScenario, setCurrentScenario] = useState(null);
          const [wornItems, setWornItems] = useState([]);
          const [gameState, setGameState] = useState('start'); 
          const [message, setMessage] = useState('');
          const [failDetails, setFailDetails] = useState(null);
          const [score, setScore] = useState(0);
          const [hintVisible, setHintVisible] = useState(false);
          const [totalSeconds, setTotalSeconds] = useState(0);
          const [isActive, setIsActive] = useState(false);
          
          const [round, setRound] = useState(1);
          const [usedScenarioIds, setUsedScenarioIds] = useState([]);
          const [employeeId, setEmployeeId] = useState('');
          const [rankings, setRankings] = useState([]);
          const [hasSaved, setHasSaved] = useState(false);
          const [isBlinking, setIsBlinking] = useState(false);

          useEffect(() => {
            const savedRankings = localStorage.getItem('ppe_game_rankings_v3');
            if (savedRankings) {
              setRankings(JSON.parse(savedRankings));
            }
          }, []);

          useEffect(() => {
            let interval = null;
            if (isActive) {
              interval = setInterval(() => {
                setTotalSeconds(s => s + 1);
              }, 1000);
            }
            return () => clearInterval(interval);
          }, [isActive]);

          useEffect(() => {
            const blinkInterval = setInterval(() => {
              setIsBlinking(true);
              setTimeout(() => setIsBlinking(false), 200);
            }, 4000);
            return () => clearInterval(blinkInterval);
          }, []);

          const startGame = () => {
            setScore(0);
            setTotalSeconds(0);
            setRound(1);
            setUsedScenarioIds([]);
            setHasSaved(false);
            setEmployeeId('');
            pickNextLevel([]);
          };

          const pickNextLevel = (currentUsedIds) => {
            const availableScenarios = SCENARIOS.filter(s => !currentUsedIds.includes(s.id));
            if (availableScenarios.length === 0) {
              setGameState('leaderboard');
              setIsActive(false);
              return;
            }
            const randomIndex = Math.floor(Math.random() * availableScenarios.length);
            const nextScenario = availableScenarios[randomIndex];
            setCurrentScenario(nextScenario);
            setUsedScenarioIds([...currentUsedIds, nextScenario.id]);
            setWornItems([]);
            setGameState('playing');
            setMessage('');
            setFailDetails(null);
            setHintVisible(false);
            setIsActive(true); 
          };

          const nextRound = () => {
            if (round >= TOTAL_ROUNDS) {
              setGameState('leaderboard');
              setIsActive(false); 
            } else {
              setRound(r => r + 1);
              pickNextLevel(usedScenarioIds);
            }
          };

          const toggleItem = (item) => {
            if (gameState !== 'playing') return;
            setWornItems(prev => {
              const isWorn = prev.find(i => i.id === item.id);
              if (isWorn) {
                return prev.filter(i => i.id !== item.id);
              } else {
                let newItems = prev.filter(i => i.category !== item.category);
                return [...newItems, item];
              }
            });
          };

          const showHint = () => {
            if (!hintVisible && gameState === 'playing') {
              setHintVisible(true);
              setScore(s => Math.max(0, s - 20));
            }
          };

          const checkAnswer = () => {
            if (!currentScenario) return;
            setIsActive(false); 

            const requiredIds = currentScenario.required.sort();
            const wornIds = wornItems.map(i => i.id);
            const missingItems = requiredIds.filter(id => !wornIds.includes(id));
            const extraItems = wornIds.filter(id => !requiredIds.includes(id));
            const requiredNames = requiredIds.map(id => EQUIPMENT_LIST.find(i => i.id === id)?.name);
            const missingNames = missingItems.map(id => EQUIPMENT_LIST.find(i => i.id === id)?.name);

            const isEntanglementHazard = currentScenario.forbidden && currentScenario.forbidden.includes('hands');
            const hasGloves = wornItems.some(i => i.category === 'hands');
            
            let isSuccess = false;
            let failMsg = '';

            if (isEntanglementHazard && hasGloves) {
                isSuccess = false;
                failMsg = '捲夾危害：旋轉機具嚴禁戴手套！';
                setFailDetails({ type: 'forbidden', text: '旋轉機具禁止戴手套，因為會被捲入機械中造成嚴重傷害。', correctList: requiredNames });
            } else if (missingItems.length === 0 && extraItems.length === 0) {
                isSuccess = true;
            } else {
                isSuccess = false;
                failMsg = '防護不完整或錯誤！';
                setFailDetails({ type: 'incorrect', missing: missingNames, correctList: requiredNames });
            }

            if (isSuccess) {
              setGameState('success');
              setScore(s => s + 100);
